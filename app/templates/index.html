<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸš¦ Traffic Generator UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}" />
</head>
<body class="container">

  <h2>ğŸŒ Traffic Generator Controller</h2>

  <!-- Apply Rate Form -->
  <form id="rate-form" class="mb-4">
    <label for="rate">Set Traffic Rate (milliseconds between packets):</label>
    <input type="number" id="rate" name="rate" class="form-control" placeholder="Rate (ms)" required min="1" />
    <button class="btn btn-primary mt-2">ğŸ’¾ Apply Rate</button>
  </form>

  <!-- Burst Mode Controls -->
  <form id="burst-form" class="mb-4">
    <label>ğŸ’¥ Start Burst:</label>
    <div class="row g-2">
      <div class="col">
        <input type="number" id="burst-rate-value" class="form-control" placeholder="Rate (ms)" required min="1" />
      </div>
      <div class="col">
        <input type="number" id="burst-duration-value" class="form-control" placeholder="Duration (sec)" required min="1" />
      </div>
      <div class="col">
        <button class="btn btn-warning w-100">ğŸ”¥ Trigger</button>
      </div>
    </div>
  </form>

  <!-- Stop Traffic -->
  <button id="stop-btn" class="btn btn-danger mb-4">ğŸ›‘ Stop Traffic</button>

  <!-- Dynamic Status Bar -->
  <div id="status-bar" class="alert alert-info mt-4 text-center">
    ğŸ“Š Current Rate: <span id="current-rate">...</span> ms |
    ğŸš€ Burst Mode: <span id="burst-mode">...</span>
    <span id="burst-remaining"></span>
    <span id="stopped-status" class="text-danger fw-bold"></span>
  </div>

  <!-- ğŸ“ˆ Embedded Grafana Panels -->
  <div class="mt-5">
    <h4>ğŸ“¦ Pods by Deployment (HPA Overview)</h4>
    <iframe
      src="http://172.16.1.170:30933/d-solo/fe38ce9s0acxsc/kubernetes-devops-internal?orgId=1&from=now-10m&to=now&refresh=5s&var-namespace=dev&var-pod=$__all&panelId=25&kiosk"
      width="100%" height="300" frameborder="0"></iframe>

    <h4>ğŸ“ˆ Live Traffic Panel (from Grafana)</h4>
    <iframe
      src="http://172.16.1.170:30933/d-solo/fe38ce9s0acxsc/kubernetes-devops-internal?orgId=1&from=now-5m&to=now&refresh=5s&var-namespace=dev&var-pod=$__all&panelId=24&kiosk"
      width="100%" height="1000" frameborder="0"></iframe>
  </div>

  <footer class="mt-5">
    <p>Made with â¤ï¸ for HPA & Observability by Luigi & Kubernetes</p>
  </footer>

  <script>
    async function refreshStatus() {
      const res = await fetch('/api/config');
      const data = await res.json();

      const currentRateElement = document.getElementById('current-rate');
      const burstModeElement = document.getElementById('burst-mode');
      const burstRemainingElement = document.getElementById('burst-remaining');
      const stoppedElement = document.getElementById('stopped-status');
      const statusBar = document.getElementById('status-bar');

      currentRateElement.innerText = data.stopped ? 'â¸' : data.rate_ms;
      burstModeElement.innerText = data.burst_mode ? 'ON' : 'OFF';
      burstRemainingElement.innerText = data.burst_mode ? ` (${data.burst_remaining}s left)` : '';
      stoppedElement.innerText = data.stopped ? 'Traffic stopped' : '';

      // Blinking status if burst mode is ON
      if (data.burst_mode && !data.stopped) {
        statusBar.classList.add('blink');
        statusBar.classList.remove('alert-info');
        statusBar.classList.add('alert-warning');
      } else {
        statusBar.classList.remove('blink');
        statusBar.classList.remove('alert-warning');
        statusBar.classList.add('alert-info');
      }
    }

    document.getElementById("rate-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const rate = parseInt(document.getElementById("rate").value);
      if (isNaN(rate) || rate < 1) {
        alert("Please enter a valid rate (min 1 ms)");
        return;
      }

      await fetch("/api/set-rate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate_ms: rate })
      });
      refreshStatus();
    });

    document.getElementById('burst-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const rate = document.getElementById('burst-rate-value').value;
      const duration = document.getElementById('burst-duration-value').value;

      if (!rate || !duration) {
        alert("Please provide valid burst parameters.");
        return;
      }

      await fetch('/api/start-burst', {
        method: 'POST',
        body: new URLSearchParams({ rate, duration })
      });
      refreshStatus();
    });

    document.getElementById('stop-btn').addEventListener('click', async () => {
      await fetch('/api/stop', { method: 'POST' });
      refreshStatus();
    });

    refreshStatus();
    setInterval(refreshStatus, 1000);
  </script>

</body>
</html>
